<!doctype html>
<html lang="zh-TW" class="h-full">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æˆ¿é–“é ç´„ç®¡ç†ç³»çµ±</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      box-sizing: border-box;
      font-family: 'Microsoft JhengHei', 'Noto Sans TC', 'PingFang TC', sans-serif;
    }
    
    .calendar-day {
      width: 38px;
      height: 38px;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 13px;
      font-weight: 600;
      background: white;
      border: 2px solid #F9A8D4;
      color: #1a1a1a;
      position: relative;
    }
    
    .calendar-day.has-booking::after {
      content: '';
      position: absolute;
      width: 6px;
      height: 6px;
      background: #DC2626;
      border-radius: 50%;
      top: 3px;
      right: 3px;
      z-index: 3;
      box-shadow: 0 0 3px rgba(220, 38, 38, 0.6);
    }
    
    .calendar-day.red-circle::before {
      content: '';
      position: absolute;
      width: 32px;
      height: 32px;
      border: 2px solid #DC2626;
      border-radius: 50%;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      z-index: 1;
    }
    
    .calendar-day span {
      position: relative;
      z-index: 2;
    }
    
    .calendar-day:hover:not(.disabled) {
      background: #FCE7F3;
      transform: scale(1.15);
      z-index: 10;
      border-color: #EC4899;
    }
    
    .calendar-day.selected {
      background: linear-gradient(135deg, #EC4899 0%, #DB2777 100%);
      color: white;
      box-shadow: 0 6px 16px rgba(236, 72, 153, 0.5);
      transform: scale(1.1);
      z-index: 5;
      border-color: #BE185D;
    }
    
    .calendar-day.today {
      border: 3px solid #F59E0B;
      font-weight: 700;
      box-shadow: 0 0 0 2px #FEF3C7;
    }
    
    .calendar-day.disabled {
      color: #D1D5DB;
      cursor: not-allowed;
      opacity: 0.35;
      border-color: #E5E7EB;
    }

    .calendar-day.public-holiday::before {
      content: '';
      position: absolute;
      width: 32px;
      height: 32px;
      border: 2px solid #DC2626;
      border-radius: 50%;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      z-index: 1;
    }

    .room-card {
      border: 2px solid #F9A8D4;
      border-radius: 8px;
      padding: 10px 20px;
      cursor: pointer;
      transition: all 0.3s ease;
      background: white;
      text-align: center;
      font-size: 14px;
    }

    .room-card:hover {
      background: #FCE7F3;
      border-color: #EC4899;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(236, 72, 153, 0.3);
    }

    .room-card.active {
      background: linear-gradient(135deg, #EC4899 0%, #DB2777 100%);
      color: white;
      border-color: #BE185D;
      box-shadow: 0 4px 12px rgba(236, 72, 153, 0.4);
    }

    .btn-primary {
      background: linear-gradient(135deg, #10B981 0%, #059669 100%);
      color: white;
      padding: 12px 24px;
      border-radius: 10px;
      font-weight: 700;
      transition: all 0.3s ease;
      border: none;
      cursor: pointer;
      box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
    }
    
    .btn-primary:hover:not(:disabled) {
      background: linear-gradient(135deg, #059669 0%, #047857 100%);
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(16, 185, 129, 0.4);
    }

    .btn-primary:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }

    .btn-secondary {
      background: linear-gradient(135deg, #3B82F6 0%, #2563EB 100%);
      color: white;
      padding: 12px 24px;
      border-radius: 10px;
      font-weight: 700;
      transition: all 0.3s ease;
      border: none;
      cursor: pointer;
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
    }
    
    .btn-secondary:hover:not(:disabled) {
      background: linear-gradient(135deg, #2563EB 0%, #1D4ED8 100%);
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(59, 130, 246, 0.4);
    }

    .btn-secondary:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }
    
    .btn-edit {
      background: linear-gradient(135deg, #F59E0B 0%, #D97706 100%);
      color: white;
      padding: 6px 12px;
      border-radius: 6px;
      font-size: 12px;
      font-weight: 600;
      transition: all 0.3s ease;
      border: none;
      cursor: pointer;
    }
    
    .btn-edit:hover {
      transform: scale(1.05);
    }
    
    .btn-delete {
      background: linear-gradient(135deg, #EF4444 0%, #DC2626 100%);
      color: white;
      padding: 6px 12px;
      border-radius: 6px;
      font-size: 12px;
      font-weight: 600;
      transition: all 0.3s ease;
      border: none;
      cursor: pointer;
    }
    
    .btn-delete:hover {
      transform: scale(1.05);
    }

    .btn-pay {
      background: linear-gradient(135deg, #10B981 0%, #059669 100%);
      color: white;
      padding: 6px 12px;
      border-radius: 6px;
      font-size: 12px;
      font-weight: 600;
      transition: all 0.3s ease;
      border: none;
      cursor: pointer;
    }
    
    .btn-pay:hover {
      transform: scale(1.05);
    }
    
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: rgba(190, 24, 93, 0.4);
      z-index: 1000;
      display: flex;
      align-items: center;
      justify-content: center;
      backdrop-filter: blur(8px);
    }
    
    .modal-content {
      background: white;
      border-radius: 20px;
      max-width: 700px;
      width: 90%;
      max-height: 90%;
      overflow-y: auto;
      box-shadow: 0 24px 60px rgba(190, 24, 93, 0.3);
      border: 3px solid #F9A8D4;
    }
    
    .booking-card {
      transition: all 0.3s ease;
      border: 2px solid #F9A8D4;
      background: white;
      border-radius: 10px;
      padding: 12px;
    }
    
    .booking-card:hover {
      background: #FFF7FC;
      transform: translateX(4px);
      box-shadow: 0 6px 20px rgba(236, 72, 153, 0.2);
      border-color: #EC4899;
    }
    
    .input-pink {
      border: 2px solid #F9A8D4;
      border-radius: 8px;
      padding: 10px 14px;
      transition: all 0.3s ease;
      font-weight: 500;
      width: 100%;
    }
    
    .input-pink:focus {
      outline: none;
      border-color: #EC4899;
      box-shadow: 0 0 0 4px rgba(236, 72, 153, 0.1);
    }
    
    .select-pink {
      border: 2px solid #F9A8D4;
      border-radius: 8px;
      padding: 10px 14px;
      transition: all 0.3s ease;
      font-weight: 600;
      background: white;
      cursor: pointer;
      width: 100%;
    }
    
    .select-pink:focus {
      outline: none;
      border-color: #EC4899;
      box-shadow: 0 0 0 4px rgba(236, 72, 153, 0.1);
    }
    
    .scrollbar-pink::-webkit-scrollbar {
      width: 8px;
    }
    
    .scrollbar-pink::-webkit-scrollbar-track {
      background: #FDF2F8;
      border-radius: 10px;
    }
    
    .scrollbar-pink::-webkit-scrollbar-thumb {
      background: linear-gradient(135deg, #EC4899 0%, #DB2777 100%);
      border-radius: 10px;
    }

    .stat-card {
      background: rgba(255, 255, 255, 0.25);
      backdrop-filter: blur(10px);
      border-radius: 10px;
      padding: 12px 20px;
      border: 2px solid rgba(255, 255, 255, 0.3);
    }

    .status-badge {
      padding: 4px 10px;
      border-radius: 6px;
      font-size: 11px;
      font-weight: 700;
      display: inline-block;
    }

    .status-pending {
      background: linear-gradient(135deg, #F59E0B 0%, #D97706 100%);
      color: white;
    }

    .status-paid {
      background: linear-gradient(135deg, #10B981 0%, #059669 100%);
      color: white;
    }

    .status-confirmed {
      background: linear-gradient(135deg, #3B82F6 0%, #2563EB 100%);
      color: white;
    }

    .price-display {
      background: linear-gradient(135deg, #FEF3C7 0%, #FDE68A 100%);
      border: 3px solid #F59E0B;
      border-radius: 12px;
      padding: 20px;
    }

    .date-nature-alert {
      border-radius: 12px;
      padding: 18px;
      border: 3px solid;
      margin-bottom: 20px;
    }

    .date-nature-alert.holiday-type {
      background: linear-gradient(135deg, #FEE2E2 0%, #FECACA 100%);
      border-color: #F87171;
    }

    .date-nature-alert.weekday-type {
      background: linear-gradient(135deg, #DCFCE7 0%, #BBF7D0 100%);
      border-color: #4ADE80;
    }
    
    .date-nature-alert.public-holiday-type {
      background: linear-gradient(135deg, #E0E7FF 0%, #C7D2FE 100%);
      border-color: #818CF8;
    }

    .calculation-card {
      border: 2px solid;
      border-radius: 10px;
      padding: 16px;
      margin-bottom: 12px;
    }

    .calculation-card.holiday-calc {
      background: #FEF2F2;
      border-color: #FCA5A5;
    }

    .calculation-card.weekday-calc {
      background: #F0FDF4;
      border-color: #86EFAC;
    }
    
    .legend-box {
      background: linear-gradient(135deg, #FFF7ED 0%, #FFEDD5 100%);
      border: 3px solid #FB923C;
      border-radius: 12px;
      padding: 16px;
      margin-top: 16px;
    }

    .login-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(135deg, #FDF2F8 0%, #FCE7F3 100%);
      z-index: 2000;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .login-container {
      background: white;
      border-radius: 20px;
      padding: 40px;
      box-shadow: 0 24px 60px rgba(190, 24, 93, 0.3);
      border: 3px solid #F9A8D4;
      max-width: 400px;
      width: 90%;
    }

    .public-view-badge {
      position: absolute;
      top: 10px;
      right: 10px;
      background: linear-gradient(135deg, #3B82F6 0%, #2563EB 100%);
      color: white;
      padding: 6px 12px;
      border-radius: 6px;
      font-size: 12px;
      font-weight: 700;
    }

    .future-booking {
      border-color: #10B981 !important;
      background: linear-gradient(135deg, #F0FDF4 0%, #DCFCE7 100%) !important;
    }

    .past-booking {
      opacity: 0.7;
      border-color: #9CA3AF !important;
      background: linear-gradient(135deg, #F3F4F6 0%, #E5E7EB 100%) !important;
    }
    
    .time-conflict-warning {
      background: linear-gradient(135deg, #FEF3C7 0%, #FDE68A 100%);
      border: 2px solid #F59E0B;
      border-radius: 8px;
      padding: 12px;
      margin: 10px 0;
      display: none;
    }
    
    .duration-warning {
      background: linear-gradient(135deg, #FEE2E2 0%, #FECACA 100%);
      border: 2px solid #F87171;
      border-radius: 8px;
      padding: 12px;
      margin: 10px 0;
      display: none;
    }
  </style>
</head>
<body class="h-full" style="background: linear-gradient(135deg, #FDF2F8 0%, #FCE7F3 100%);">
  <!-- ç™»å…¥é®ç½© -->
  <div id="login-overlay" class="login-overlay">
    <div class="login-container">
      <h2 class="text-2xl font-bold text-pink-900 mb-6 text-center">ğŸµ å¡é›…éŸ³æ¨‚æ•™å®¤</h2>
      <p class="text-pink-700 mb-6 text-center">è«‹é¸æ“‡é€²å…¥æ¨¡å¼</p>
      <div class="space-y-4">
        <button id="public-access-btn" class="btn-secondary w-full py-4 text-lg">
          ğŸŒ å…¬é–‹é ç´„ç³»çµ±
        </button>
        <div class="text-center text-gray-500 text-sm">æˆ–</div>
        <div>
          <label class="block text-sm font-bold text-pink-900 mb-2">ğŸ”‘ å·¥ä½œäººå“¡ç™»å…¥å¯†ç¢¼</label>
          <input type="password" id="staff-password" class="input-pink mb-4" placeholder="è¼¸å…¥ç®¡ç†å¯†ç¢¼">
          <button id="staff-login-btn" class="btn-primary w-full py-4 text-lg">
            ğŸ‘¨â€ğŸ’¼ å·¥ä½œäººå“¡ç™»å…¥
          </button>
        </div>
        <p class="text-xs text-gray-500 text-center mt-4">
          å…¬é–‹é ç´„ç³»çµ±ï¼šåªèƒ½æŸ¥çœ‹å¯é ç´„æ™‚æ®µä¸¦æäº¤é ç´„<br>
          å·¥ä½œäººå“¡ç³»çµ±ï¼šå¯ä»¥ç®¡ç†æ‰€æœ‰é ç´„è¨˜éŒ„
        </p>
      </div>
    </div>
  </div>

  <!-- ä¸»è¦æ‡‰ç”¨ç¨‹å¼å…§å®¹ï¼ˆåˆå§‹éš±è—ï¼‰ -->
  <div id="app-content" class="h-full flex flex-col overflow-hidden" style="display: none;">
   <header style="background: linear-gradient(135deg, #EC4899 0%, #DB2777 100%); border-bottom: 4px solid #BE185D;" class="px-8 py-4 shadow-xl">
    <div class="flex justify-between items-center">
     <div class="flex items-center gap-4">
      <div class="text-5xl">
       ğŸµ
      </div>
      <div>
       <h1 id="company-name" class="text-2xl font-bold text-white" style="text-shadow: 2px 2px 4px rgba(0,0,0,0.2);">å¡é›…éŸ³æ¨‚æ•™å®¤</h1>
       <p class="text-pink-100 text-xs mt-1 font-semibold">ğŸ“ <span id="address-info">é¦™æ¸¯ä¸Šæ°´ç¬¦èˆˆè¡—43-45è™Ÿ1Bå®¤</span> | ğŸ“ <span id="contact-phone">5400 1874</span></p>
      </div>
     </div>
     <div class="flex items-center gap-4">
      <!-- å…¬é–‹æ¨¡å¼æç¤º -->
      <div id="public-mode-badge" class="public-view-badge" style="display: none;">
        ğŸŒ å…¬é–‹é ç´„æ¨¡å¼
      </div>
      
      <!-- çµ±è¨ˆè³‡è¨Šï¼ˆåƒ…å·¥ä½œäººå“¡å¯è¦‹ï¼‰ -->
      <div id="statistics-section">
       <div class="flex gap-3">
        <div class="stat-card text-center">
         <p class="text-xs font-semibold text-white mb-1">ğŸ“Š æœ¬æœˆæ”¶å…¥</p>
         <p class="text-xl font-bold text-white" id="month-income">$0</p>
        </div>
        <div class="stat-card text-center">
         <p class="text-xs font-semibold text-white mb-1">ğŸ“ˆ æœ¬å¹´ç´¯è¨ˆ</p>
         <p class="text-xl font-bold text-white" id="year-income">$0</p>
        </div>
       </div>
       <div class="text-white text-right">
        <div class="text-3xl font-bold" id="current-year-display"></div>
        <div class="text-xs font-semibold text-pink-100">
         å¹´åº¦é ç´„ç³»çµ±
        </div>
       </div>
      </div>
     </div>
    </div>
   </header>

   <main class="flex-1 flex overflow-hidden">
    <!-- å·¦å´ä¸»å€ -->
    <section class="flex flex-col overflow-hidden" style="width: 70%; background: linear-gradient(180deg, #FFFBFE 0%, #FFF7FC 100%);">
     <div class="bg-white border-b-3 border-pink-300 px-6 py-4 shadow-md">
      <h2 class="text-xl font-bold text-pink-900 flex items-center gap-2"><span class="text-2xl">ğŸµ</span> <span>é¸æ“‡æˆ¿é–“èˆ‡é ç´„æ™‚é–“</span></h2>
     </div>
     <div class="flex-1 overflow-y-auto scrollbar-pink p-6">
      <form id="booking-form" class="space-y-6">
       <!-- æˆ¿é–“é¸æ“‡å¡ç‰‡ -->
       <div class="bg-white rounded-xl border-3 border-pink-300 p-6 shadow-lg">
        <h3 class="text-lg font-bold text-pink-900 mb-4">ğŸ¹ é¸æ“‡æˆ¿é–“</h3>
        <div class="flex gap-2 mb-5 flex-wrap">
         <div class="room-card" data-room="A">
          <div class="font-bold">
           Aæˆ¿
          </div>
         </div>
         <div class="room-card" data-room="B">
          <div class="font-bold">
           Bæˆ¿
          </div>
         </div>
         <div class="room-card" data-room="C">
          <div class="font-bold">
           Cæˆ¿
          </div>
         </div>
         <div class="room-card" data-room="D">
          <div class="font-bold">
           Dæˆ¿
          </div>
         </div>
         <div class="room-card" data-room="E">
          <div class="font-bold">
           Eæˆ¿
          </div>
         </div>
         <div class="room-card" data-room="1">
          <div class="font-bold">
           1æˆ¿
          </div>
         </div>
         <div class="room-card" data-room="2">
          <div class="font-bold">
           2æˆ¿
          </div>
         </div>
        </div>
        <div id="room-info" style="display: none;" class="bg-gradient-to-r from-pink-50 to-pink-100 border-2 border-pink-400 rounded-xl p-5">
         <h4 class="font-bold text-pink-900 text-lg mb-3" id="room-info-title"></h4>
         <div class="space-y-2 text-sm text-pink-800 font-semibold">
          <p><span class="inline-block w-24">ğŸ“ é¢ç©ï¼š</span><span id="room-info-area"></span></p>
          <p><span class="inline-block w-24">ğŸ‘¥ å®¹ç´äººæ•¸ï¼š</span><span id="room-info-capacity"></span></p>
          <p><span class="inline-block w-24">ğŸ› ï¸ è¨­å‚™ï¼š</span><span id="room-info-equipment"></span></p>
          <p><span class="inline-block w-24">ğŸ’° æ”¶è²»ï¼š</span><span id="room-info-rates"></span></p>
          <p id="room-info-video" style="display: none;"><span class="inline-block w-24">ğŸ“¹ éŒ„å½±æœå‹™ï¼š</span><span id="room-info-video-rates"></span></p>
         </div>
        </div>
       </div>

       <!-- æ—¥æœŸé¸æ“‡ -->
       <div class="bg-white rounded-xl border-3 border-pink-300 p-6 shadow-lg">
        <div class="flex justify-between items-center mb-4">
         <h3 class="text-lg font-bold text-pink-900">ğŸ“… é¸æ“‡æ—¥æœŸï¼ˆå¯å¤šé¸ï¼‰</h3>
         <div class="flex gap-2">
          <button type="button" id="today-btn" class="bg-white text-pink-600 border-2 border-pink-400 px-3 py-1 rounded-lg text-sm font-bold hover:bg-pink-50">æœ¬æœˆ</button>
          <button type="button" id="prev-month-btn" class="bg-white text-pink-600 border-2 border-pink-400 px-3 py-1 rounded-lg text-sm font-bold hover:bg-pink-50">ä¸Šæœˆ</button>
          <button type="button" id="next-month-btn" class="bg-white text-pink-600 border-2 border-pink-400 px-3 py-1 rounded-lg text-sm font-bold hover:bg-pink-50">ä¸‹æœˆ</button>
         </div>
        </div>
        <div class="bg-pink-50 rounded-lg p-3 border-2 border-pink-300">
         <h4 id="calendar-month-year" class="text-center text-lg font-bold text-pink-900 mb-3"></h4>
         <div class="grid grid-cols-7 gap-1.5 mb-2">
          <div class="text-center text-xs font-bold text-red-600">æ—¥</div>
          <div class="text-center text-xs font-bold text-pink-900">ä¸€</div>
          <div class="text-center text-xs font-bold text-pink-900">äºŒ</div>
          <div class="text-center text-xs font-bold text-pink-900">ä¸‰</div>
          <div class="text-center text-xs font-bold text-pink-900">å››</div>
          <div class="text-center text-xs font-bold text-pink-900">äº”</div>
          <div class="text-center text-xs font-bold text-blue-600">å…­</div>
         </div>
         <div id="calendar-grid" class="grid grid-cols-7 gap-1.5"></div>
        </div>

        <!-- åœ–ä¾‹èªªæ˜ -->
        <div class="legend-box">
         <p class="font-bold text-orange-900 text-sm mb-2">ğŸ“… æ—¥æ›†åœ–ä¾‹ï¼š</p>
         <div class="space-y-1 text-xs text-orange-800 font-semibold">
          <p>ğŸ”´ <strong>ç´…åœˆæ—¥æœŸ</strong> = æ˜ŸæœŸå…­ã€æ—¥åŠå…¬çœ¾å‡æœŸï¼ˆå‡æ—¥æ”¶è²»ï¼‰</p>
          <p>âœ… <strong>ç²‰ç´…é«˜äº®</strong> = æ‚¨é¸æ“‡çš„æ—¥æœŸ</p>
          <p>ğŸ”´ <strong>å³ä¸Šç´…é»</strong> = ç•¶æ—¥å·²æœ‰é ç´„</p>
          <p>ğŸ“… <strong>é€±ä¸€è‡³äº”ï¼ˆå…¬çœ¾å‡æœŸå¤–ï¼‰</strong> = æŒ‰å¹³æ—¥æ”¶è²»</p>
         </div>
        </div>

        <div class="mt-6 bg-white border-2 border-pink-300 rounded-lg p-3">
         <p class="text-sm font-bold text-pink-900 mb-2">âœ… å·²é¸ <span id="selected-count" class="text-xl text-pink-600">0</span> å€‹æ—¥æœŸ</p>
         <div id="selected-dates-display" class="flex flex-wrap gap-2">
          <span class="text-xs text-gray-500">å°šæœªé¸æ“‡</span>
         </div>
        </div>
       </div>

       <!-- ç³»çµ±æ™ºæ…§æç¤ºå€ -->
       <div id="date-nature-alerts-container"></div>

       <!-- æ™‚æ®µé¸æ“‡ -->
       <div class="bg-white rounded-xl border-3 border-pink-300 p-6 shadow-lg">
        <h3 class="text-lg font-bold text-pink-900 mb-2">â° é¸æ“‡é ç´„æ™‚æ®µ</h3>
        <p class="text-xs text-pink-700 mb-4">ğŸ’¡ è«‹é¸æ“‡é–‹å§‹èˆ‡çµæŸæ™‚é–“ï¼ˆæœ€å°‘1å°æ™‚ï¼Œ1å°æ™‚å¾Œæ¯åŠå°æ™‚å¢åŠ ï¼‰</p>
        
        <!-- æ™‚æ®µè¡çªè­¦å‘Š -->
        <div id="time-conflict-warning" class="time-conflict-warning">
          <p class="text-sm font-bold text-amber-900 mb-1">âš ï¸ æ™‚æ®µè¡çªè­¦å‘Š</p>
          <p class="text-xs text-amber-800" id="conflict-message"></p>
        </div>
        
        <!-- æ™‚é•·è­¦å‘Š -->
        <div id="duration-warning" class="duration-warning">
          <p class="text-sm font-bold text-red-900 mb-1">âš ï¸ é ç´„æ™‚é•·é™åˆ¶</p>
          <p class="text-xs text-red-800" id="duration-message">æ¯æ¬¡é ç´„æœ€å°‘1å°æ™‚ï¼Œ1å°æ™‚å¾Œå¯æ¯åŠå°æ™‚å¢åŠ </p>
        </div>
        
        <div class="grid grid-cols-3 gap-4">
         <div>
          <label class="block text-sm font-bold text-pink-900 mb-2">é–‹å§‹æ™‚é–“ï¼š</label>
          <select id="start-time-select" class="select-pink">
           <option value="">è«‹é¸æ“‡</option>
          </select>
         </div>
         <div>
          <label class="block text-sm font-bold text-pink-900 mb-2">çµæŸæ™‚é–“ï¼š</label>
          <select id="end-time-select" class="select-pink">
           <option value="">è«‹é¸æ“‡</option>
          </select>
         </div>
         <div class="flex flex-col gap-2">
          <div class="flex gap-2">
           <button type="button" data-hours="1" class="duration-btn bg-white text-pink-600 border-2 border-pink-400 px-3 py-2 rounded-lg text-sm font-bold hover:bg-pink-50 flex-1">1å°æ™‚</button>
           <button type="button" data-hours="1.5" class="duration-btn bg-white text-pink-600 border-2 border-pink-400 px-3 py-2 rounded-lg text-sm font-bold hover:bg-pink-50 flex-1">1.5å°æ™‚</button>
           <button type="button" data-hours="2" class="duration-btn bg-white text-pink-600 border-2 border-pink-400 px-3 py-2 rounded-lg text-sm font-bold hover:bg-pink-50 flex-1">2å°æ™‚</button>
          </div>
          <div class="flex gap-2">
           <button type="button" data-hours="2.5" class="duration-btn bg-white text-pink-600 border-2 border-pink-400 px-3 py-2 rounded-lg text-sm font-bold hover:bg-pink-50 flex-1">2.5å°æ™‚</button>
           <button type="button" data-hours="3" class="duration-btn bg-white text-pink-600 border-2 border-pink-400 px-3 py-2 rounded-lg text-sm font-bold hover:bg-pink-50 flex-1">3å°æ™‚</button>
           <button type="button" data-hours="4" class="duration-btn bg-white text-pink-600 border-2 border-pink-400 px-3 py-2 rounded-lg text-sm font-bold hover:bg-pink-50 flex-1">4å°æ™‚</button>
          </div>
         </div>
        </div>
        <div class="mt-4 bg-pink-50 border-2 border-pink-300 rounded-lg p-3">
         <p class="text-xs font-bold text-pink-900 mb-1">ğŸ• å·²é¸æ™‚æ®µï¼š</p>
         <div id="selected-time-display" class="text-sm text-pink-800 font-semibold">
          <span class="text-gray-500">å°šæœªé¸æ“‡</span>
         </div>
        </div>
       </div>

       <!-- è‡ªå‹•è¨ˆè²»é¡¯ç¤ºå€ -->
       <div class="bg-white rounded-xl border-3 border-pink-300 p-6 shadow-lg">
        <h3 class="text-lg font-bold text-pink-900 mb-2">ğŸ’° é ç´„è²»ç”¨è¨ˆç®—</h3>
        <p class="text-xs text-pink-700 mb-4">ğŸ’¡ é€¢æ˜ŸæœŸå…­æ—¥åŠå…¬çœ¾å‡æœŸæŒ‰å‡æ—¥è²»ç‡ï¼Œå…¬çœ¾å‡æœŸåœ¨é€±ä¸€è‡³äº”ä¹ŸæŒ‰å‡æ—¥è²»ç‡</p>
        <div class="price-display">
         <div id="price-breakdown" class="space-y-3 mb-4">
          <p class="text-gray-500 text-center text-sm">è«‹é¸æ“‡æˆ¿é–“ã€æ—¥æœŸå’Œæ™‚æ®µ</p>
         </div>
         <div id="video-service-option" style="display: none;" class="mb-3 p-3 bg-white rounded-lg border-2 border-amber-300">
          <label class="flex items-center gap-2 cursor-pointer">
           <input type="checkbox" id="video-service-checkbox" class="w-5 h-5 cursor-pointer">
           <span class="font-bold text-pink-900">ğŸ“¹ åŠ è³¼éŒ„å½±æœå‹™ <span id="video-service-price" class="text-amber-600"></span></span>
          </label>
         </div>
         <div id="discount-display" style="display: none;" class="mb-3 p-3 bg-green-50 rounded-lg border-2 border-green-300">
          <p class="text-sm font-bold text-green-700">ğŸ‰ èˆŠå®¢æˆ¶9æŠ˜å„ªæƒ </p>
          <p class="text-xs text-green-600">åŸåƒ¹ <span id="original-price-text" class="line-through"></span> â†’ æŠ˜å¾Œ <span id="discount-price-text" class="font-bold"></span></p>
         </div>
         <div class="flex items-center justify-between pt-3 border-t-2 border-amber-400">
          <span class="text-lg font-bold text-pink-900">ç¸½æ•¸ï¼š</span>
          <span id="total-price-display" class="text-3xl font-bold text-pink-600">$0</span>
         </div>
        </div>
       </div>

       <!-- é ç´„è©³æƒ…èˆ‡ä»˜æ¬¾ -->
       <div class="bg-white rounded-xl border-3 border-pink-300 p-6 shadow-lg">
        <h3 class="text-lg font-bold text-pink-900 mb-4">ğŸ“ é ç´„è©³æƒ…</h3>
        <div class="space-y-4">
         <div>
          <label class="block text-sm font-bold text-pink-900 mb-2">ğŸ‘¤ é ç´„äººå§“åï¼š</label>
          <input type="text" id="user-name" required class="input-pink">
         </div>
         <div>
          <label class="block text-sm font-bold text-pink-900 mb-2">ğŸ“± WHATSAPPè¯çµ¡æ–¹æ³•ï¼š</label>
          <input type="tel" id="phone" required class="input-pink" placeholder="è«‹è¼¸å…¥WhatsAppè™Ÿç¢¼">
         </div>
         <div>
          <label class="block text-sm font-bold text-pink-900 mb-2">ğŸ¯ ä½¿ç”¨ç”¨é€”ï¼š</label>
          <select id="purpose-select" class="select-pink">
           <option value="ä¸€èˆ¬é ç´„">ä¸€èˆ¬é ç´„</option>
           <option value="èª¿éŸ³">èª¿éŸ³</option>
           <option value="å…§éƒ¨ä½¿ç”¨">å…§éƒ¨ä½¿ç”¨</option>
           <option value="æ•™å­¸">æ•™å­¸</option>
           <option value="ç·´ç¿’">ç·´ç¿’</option>
           <option value="æ´»å‹•">æ´»å‹•</option>
          </select>
         </div>
         <div id="returning-customer-container" style="display: block;">
          <label class="flex items-center gap-2 cursor-pointer">
           <input type="checkbox" id="is-returning-customer" class="w-5 h-5 cursor-pointer">
           <span class="text-sm font-bold text-pink-900">èˆŠå®¢æˆ¶ï¼ˆè‡ªå‹•9æŠ˜ï¼‰</span>
          </label>
         </div>
         <div>
          <label class="block text-sm font-bold text-pink-900 mb-2">ğŸ“ å‚™è¨»ï¼š</label>
          <textarea id="notes" class="input-pink" rows="3" placeholder="å¦‚æœ‰å…¶ä»–ç‰¹æ®Šéœ€æ±‚ï¼Œè«‹åœ¨æ­¤å¡«å¯«"></textarea>
         </div>
         <div class="bg-pink-50 border-2 border-pink-300 rounded-lg p-4">
          <label class="block text-sm font-bold text-pink-900 mb-2">ğŸ’µ é è¨ˆè²»ç”¨ï¼š</label>
          <div class="flex items-center gap-3">
           <span class="text-xl font-bold">$</span>
           <input type="number" id="manual-price" min="0" step="1" class="input-pink w-40" readonly>
          </div>
         </div>
         <div id="payment-instructions" class="pt-3 border-t-2 border-pink-300">
          <p class="text-sm text-blue-700 mb-2">ğŸ“± è«‹ç­‰å€™ç´å®¤WhatsAppè¯çµ¡å®‰æ’ä»˜æ¬¾</p>
          <p class="text-xs text-blue-600 mb-3">â° å¦‚24å°æ™‚å…§æœªæ”¶åˆ°é€šçŸ¥ï¼Œè«‹è‡´é›»æœ¬ç´å®¤ <span class="font-bold">5400 1874</span> ç¢ºèªé ç´„</p>
          <button type="submit" id="submit-booking-btn" class="btn-primary w-full py-4 text-base">
            ğŸ“ æäº¤é ç´„ç”³è«‹
          </button>
         </div>
         <div id="staff-payment-section" style="display: none;" class="pt-3 border-t-2 border-pink-300">
          <p class="text-xs text-pink-700 mb-3">ğŸ’¡ ç«‹å³ä»˜æ¬¾ç¢ºèªé ç´„ï¼Œæˆ–å…ˆä¿ç•™æ™‚æ®µå¾Œä»˜æ¬¾</p>
          <div class="grid grid-cols-2 gap-4">
           <button type="button" id="submit-paid-btn" class="btn-primary py-4 text-base">âœ… ç«‹å³ä»˜æ¬¾ç¢ºèªé ç´„</button>
           <button type="button" id="submit-pending-btn" class="btn-secondary py-4 text-base">ğŸ“ å…ˆé ç´„å¾Œä»˜æ¬¾</button>
          </div>
         </div>
        </div>
       </div>
      </form>
     </div>
    </section>

    <!-- å³å´é‚Šæ¬„ (åƒ…å·¥ä½œäººå“¡å¯è¦‹) -->
    <aside id="sidebar" class="flex flex-col overflow-hidden border-l-4 border-pink-300 shadow-xl" style="width: 30%; background: linear-gradient(180deg, #FDF2F8 0%, #FCE7F3 100%); display: none;">
     <div class="flex-1 flex flex-col overflow-hidden">
      <div class="px-6 py-4 bg-white border-b-2 border-pink-300">
       <h2 class="text-xl font-bold text-pink-900 mb-3 flex items-center gap-2"><span class="text-2xl">ğŸ“‹</span> <span>é ç´„æ¸…å–®</span></h2>
       <div class="space-y-2">
        <div>
         <label class="block text-xs font-bold text-pink-900 mb-1">ğŸ” æˆ¿é–“ç¯©é¸</label>
         <select id="room-filter" class="select-pink text-sm">
          <option value="">å…¨éƒ¨æˆ¿é–“</option>
          <option value="A">æˆ¿é–“A (ä¸‰è§’ç´)</option>
          <option value="B">æˆ¿é–“B (ç›´èº«ç´)</option>
          <option value="C">æˆ¿é–“C (æ•¸ç¢¼ç´)</option>
          <option value="D">æˆ¿é–“D (ç›´èº«ç´)</option>
          <option value="E">æˆ¿é–“E (ç›´èº«ç´)</option>
          <option value="1">æˆ¿é–“1 (æ´»å‹•æˆ¿)</option>
          <option value="2">æˆ¿é–“2 (ç›´èº«ç´ä¼´å¥)</option>
         </select>
        </div>
        <div>
         <label class="block text-xs font-bold text-pink-900 mb-1">ğŸ·ï¸ ç‹€æ…‹ç¯©é¸</label>
         <select id="status-filter" class="select-pink text-sm">
          <option value="">å…¨éƒ¨ç‹€æ…‹</option>
          <option value="pending">å¾…ç¢ºèª</option>
          <option value="paid">å·²ä»˜æ¬¾</option>
         </select>
        </div>
        <div>
         <label class="block text-xs font-bold text-pink-900 mb-1">ğŸ“… æ—¥æœŸæ’åº</label>
         <select id="date-sort" class="select-pink text-sm">
          <option value="future-first">æœªåˆ°æ—¥æœŸå„ªå…ˆ</option>
          <option value="past-first">éå¾€æ—¥æœŸå„ªå…ˆ</option>
          <option value="newest">æœ€æ–°é ç´„</option>
         </select>
        </div>
       </div>
      </div>
      <div class="flex-1 overflow-y-auto scrollbar-pink p-6">
       <div id="booking-list" class="space-y-3"></div>
      </div>
     </div>
    </aside>
   </main>
  </div>

  <!-- Toast é€šçŸ¥å®¹å™¨ -->
  <div id="toast-container" class="fixed top-20 right-6 z-50 space-y-3"></div>

  <script>
    const rooms = [
      { 
        id: 'A', 
        name: 'æˆ¿é–“A', 
        subtitle: '(ä¸‰è§’ç´)', 
        area: 'ç´„150å‘', 
        capacity: '2-10äºº', 
        equipment: 'ğŸ“± æ‰‹æ©Ÿ/ç›¸æ©Ÿè…³æ¶ã€è­œæ¶', 
        rates: { weekday: 280, weekend: 380 },
        videoRates: { weekday: 580, weekend: 680 },
        hasVideo: true
      },
      { id: 'B', name: 'æˆ¿é–“B', subtitle: '(ç›´èº«ç´)', area: 'ç´„30å‘', capacity: '2äºº', equipment: 'è­œæ¶', rates: { weekday: 60, weekend: 90 }, hasVideo: false },
      { id: 'C', name: 'æˆ¿é–“C', subtitle: '(æ•¸ç¢¼ç´)', area: 'ç´„40å‘', capacity: '2äºº', equipment: 'è­œæ¶', rates: { weekday: 60, weekend: 90 }, hasVideo: false },
      { id: 'D', name: 'æˆ¿é–“D', subtitle: '(ç›´èº«ç´)', area: 'ç´„30å‘', capacity: '2äºº', equipment: 'è­œæ¶', rates: { weekday: 60, weekend: 90 }, hasVideo: false },
      { id: 'E', name: 'æˆ¿é–“E', subtitle: '(ç›´èº«ç´)', area: 'ç´„30å‘', capacity: '2äºº', equipment: 'è­œæ¶', rates: { weekday: 60, weekend: 90 }, hasVideo: false },
      { id: '1', name: 'æˆ¿é–“1', subtitle: '(æ´»å‹•æˆ¿)', area: 'ç´„70å‘', capacity: '2-10äºº', equipment: 'é•·æ¡Œã€æ¤…å­(æŒ‰éœ€è¦æ•¸é‡æä¾›)', rates: { weekday: 100, weekend: 150 }, hasVideo: false },
      { id: '2', name: 'æˆ¿é–“2', subtitle: '(ç›´èº«ç´ä¼´å¥)', area: 'ç´„50å‘', capacity: '2-3äºº', equipment: 'è­œæ¶', rates: { weekday: 80, weekend: 120 }, hasVideo: false }
    ];

    // å®Œæ•´çš„å…¬çœ¾å‡æœŸæ•¸æ“š
    const publicHolidays = {
      // 2027å¹´å‡æœŸ
      '2027-01-01': 'ä¸€æœˆä¸€æ—¥',
      '2027-02-06': 'è¾²æ›†æ–°å¹´åˆä¸€',
      '2027-02-07': 'è¾²æ›†æ–°å¹´åˆäºŒ',
      '2027-02-08': 'è¾²æ›†æ–°å¹´åˆä¸‰',
      '2027-02-09': 'è¾²æ›†æ–°å¹´åˆå››',
      '2027-03-26': 'è€¶ç©Œå—é›£ç¯€',
      '2027-03-27': 'è€¶ç©Œå—é›£ç¯€ç¿Œæ—¥',
      '2027-03-29': 'å¾©æ´»ç¯€æ˜ŸæœŸä¸€',
      '2027-04-05': 'æ¸…æ˜ç¯€',
      '2027-05-01': 'å‹å‹•ç¯€',
      '2027-05-13': 'ä½›èª•',
      '2027-06-09': 'ç«¯åˆç¯€',
      '2027-07-01': 'é¦™æ¸¯ç‰¹åˆ¥è¡Œæ”¿å€æˆç«‹ç´€å¿µæ—¥',
      '2027-09-16': 'ä¸­ç§‹ç¯€ç¿Œæ—¥',
      '2027-10-01': 'åœ‹æ…¶æ—¥',
      '2027-10-08': 'é‡é™½ç¯€',
      '2027-12-25': 'è–èª•ç¯€',
      '2027-12-27': 'è–èª•ç¯€å¾Œç¬¬ä¸€å€‹å‘¨æ—¥',
      
      // 2028å¹´å‡æœŸ
      '2028-01-01': 'ä¸€æœˆä¸€æ—¥',
      '2028-01-26': 'è¾²æ›†æ–°å¹´åˆä¸€',
      '2028-01-27': 'è¾²æ›†æ–°å¹´åˆäºŒ',
      '2028-01-28': 'è¾²æ›†æ–°å¹´åˆä¸‰',
      '2028-04-04': 'æ¸…æ˜ç¯€',
      '2028-04-14': 'è€¶ç©Œå—é›£ç¯€',
      '2028-04-15': 'è€¶ç©Œå—é›£ç¯€ç¿Œæ—¥',
      '2028-04-17': 'å¾©æ´»ç¯€æ˜ŸæœŸä¸€',
      '2028-05-01': 'å‹å‹•ç¯€',
      '2028-05-02': 'ä½›èª•',
      '2028-05-29': 'ç«¯åˆç¯€',
      '2028-07-01': 'é¦™æ¸¯ç‰¹åˆ¥è¡Œæ”¿å€æˆç«‹ç´€å¿µæ—¥',
      '2028-10-01': 'åœ‹æ…¶æ—¥',
      '2028-10-04': 'ä¸­ç§‹ç¯€ç¿Œæ—¥',
      '2028-10-26': 'é‡é™½ç¯€',
      '2028-12-25': 'è–èª•ç¯€',
      '2028-12-26': 'è–èª•ç¯€å¾Œç¬¬ä¸€å€‹å‘¨æ—¥'
    };

    // æ·»åŠ æœªä¾†å¹´ä»½çš„å‡æœŸï¼ˆç°¡å–®é æ¸¬ï¼‰
    function addFutureHolidays() {
      const currentYear = new Date().getFullYear();
      
      // æ·»åŠ 2029å¹´å‡æœŸï¼ˆç°¡å–®ä¼°ç®—ï¼‰
      publicHolidays['2029-01-01'] = 'ä¸€æœˆä¸€æ—¥';
      publicHolidays['2029-02-13'] = 'è¾²æ›†æ–°å¹´åˆä¸€';
      publicHolidays['2029-02-14'] = 'è¾²æ›†æ–°å¹´åˆäºŒ';
      publicHolidays['2029-02-15'] = 'è¾²æ›†æ–°å¹´åˆä¸‰';
      publicHolidays['2029-04-05'] = 'æ¸…æ˜ç¯€';
      publicHolidays['2029-05-01'] = 'å‹å‹•ç¯€';
      publicHolidays['2029-07-01'] = 'é¦™æ¸¯ç‰¹åˆ¥è¡Œæ”¿å€æˆç«‹ç´€å¿µæ—¥';
      publicHolidays['2029-10-01'] = 'åœ‹æ…¶æ—¥';
      publicHolidays['2029-12-25'] = 'è–èª•ç¯€';
      publicHolidays['2029-12-26'] = 'è–èª•ç¯€å¾Œç¬¬ä¸€å€‹å‘¨æ—¥';
    }
    
    addFutureHolidays();

    const STAFF_PASSWORD = "kaya2026"; // å·¥ä½œäººå“¡å¯†ç¢¼

    // ä½¿ç”¨ localStorage ä¾†å„²å­˜é ç´„æ•¸æ“š
    const STORAGE_KEY = 'kaya_music_bookings';
    const DEFAULT_BOOKINGS = [];

    let bookings = [];
    let selectedDates = [];
    let currentCalendarMonth = new Date(); // è¨­ç‚ºç•¶å‰æœˆä»½
    let currentRoom = '';
    let currentRoomFilter = '';
    let currentStatusFilter = '';
    let currentDateSort = 'future-first';
    let isStaffMode = false;
    let isPublicMode = false;

    // æ–°çš„æ”¶è²»è¨ˆç®—å‡½æ•¸ï¼ˆè€ƒæ…®é€±æœ«ä¸‹åˆ2é»å‰å¾Œï¼‰
    function calculateRateForRoom(roomId, date, startTime) {
      const isHoliday = isPublicHoliday(date);
      const isWeekendDay = isWeekend(date);
      
      // å…¬çœ¾å‡æœŸä¸€å¾‹æŒ‰å‡æ—¥è²»ç‡ï¼ˆå…¨æ—¥ï¼‰
      if (isHoliday) {
        if (['B', 'C', 'D', 'E'].includes(roomId)) return 90;
        if (roomId === '2') return 120;
      }
      
      // é€±æœ«è€ƒæ…®ä¸‹åˆ2é»å‰å¾Œ
      if (isWeekendDay) {
        const [startHour, startMinute] = startTime.split(':').map(Number);
        const isAfter2PM = startHour >= 14; // 14:00åŠä¹‹å¾Œç®—ä¸‹åˆ2é»å¾Œ
        
        // B, C, D, E æˆ¿
        if (['B', 'C', 'D', 'E'].includes(roomId)) {
          return isAfter2PM ? 90 : 60;
        }
        
        // 2æˆ¿
        if (roomId === '2') {
          return isAfter2PM ? 120 : 80;
        }
      }
      
      // å¹³æ—¥æˆ–éB/C/D/E/2æˆ¿
      const room = rooms.find(r => r.id === roomId);
      if (!room) return 0;
      
      return room.rates.weekday;
    }

    // è¨ˆç®—éŒ„å½±æœå‹™é¡å¤–è²»ç”¨
    function calculateVideoExtra(roomId, date, startTime) {
      if (roomId === 'A') {
        const isHoliday = isPublicHoliday(date);
        const isWeekendDay = isWeekend(date);
        const room = rooms.find(r => r.id === roomId);
        
        if (isHoliday || isWeekendDay) {
          return room.videoRates.weekend - room.rates.weekend;
        } else {
          return room.videoRates.weekday - room.rates.weekday;
        }
      }
      return 0;
    }

    // è¼‰å…¥é ç´„æ•¸æ“š
    function loadBookings() {
      try {
        const saved = localStorage.getItem(STORAGE_KEY);
        if (saved) {
          const parsed = JSON.parse(saved);
          bookings = parsed.map(booking => ({
            id: booking.id || Date.now().toString() + Math.random().toString(36).substr(2, 9),
            room_id: booking.room_id || '',
            start_date: booking.start_date || '',
            start_time: booking.start_time || '',
            end_time: booking.end_time || '',
            user_name: booking.user_name || '',
            phone: booking.phone || '',
            purpose: booking.purpose || 'ä¸€èˆ¬é ç´„',
            notes: booking.notes || '',
            total_amount: booking.total_amount || 0,
            original_amount: booking.original_amount || booking.total_amount || 0,
            payment_status: booking.payment_status || 'pending',
            is_returning_customer: booking.is_returning_customer || false,
            manual_price_override: booking.manual_price_override || false,
            created_at: booking.created_at || new Date().toISOString(),
            has_video_service: booking.has_video_service || false,
            date_nature: booking.date_nature || 'å¹³æ—¥',
            is_past_date: booking.is_past_date || false
          }));
        } else {
          bookings = DEFAULT_BOOKINGS;
        }
      } catch (e) {
        console.error('è¼‰å…¥é ç´„æ•¸æ“šå¤±æ•—:', e);
        bookings = DEFAULT_BOOKINGS;
      }
    }

    // å„²å­˜é ç´„æ•¸æ“š
    function saveBookings() {
      try {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(bookings));
      } catch (e) {
        console.error('å„²å­˜é ç´„æ•¸æ“šå¤±æ•—:', e);
      }
    }

    // æª¢æŸ¥æ™‚æ®µæ˜¯å¦è¡çª
    function checkTimeConflict(roomId, dateStr, startTime, endTime, excludeBookingId = null) {
      if (!startTime || !endTime) return false;
      
      const [startH, startM] = startTime.split(':').map(Number);
      const [endH, endM] = endTime.split(':').map(Number);
      const newStartMinutes = startH * 60 + startM;
      const newEndMinutes = endH * 60 + endM;
      
      // æª¢æŸ¥æ˜¯å¦èˆ‡ç¾æœ‰é ç´„è¡çª
      for (const booking of bookings) {
        // æ’é™¤è‡ªèº«ï¼ˆç·¨è¼¯æ™‚ï¼‰
        if (excludeBookingId && booking.id === excludeBookingId) continue;
        
        // åªæª¢æŸ¥ç›¸åŒæˆ¿é–“å’Œæ—¥æœŸçš„é ç´„
        if (booking.room_id === roomId && booking.start_date === dateStr && booking.payment_status !== 'cancelled') {
          const [existingStartH, existingStartM] = booking.start_time.split(':').map(Number);
          const [existingEndH, existingEndM] = booking.end_time.split(':').map(Number);
          const existingStartMinutes = existingStartH * 60 + existingStartM;
          const existingEndMinutes = existingEndH * 60 + existingEndM;
          
          // æª¢æŸ¥æ™‚é–“æ˜¯å¦é‡ç–Š
          const isOverlap = (
            (newStartMinutes >= existingStartMinutes && newStartMinutes < existingEndMinutes) ||
            (newEndMinutes > existingStartMinutes && newEndMinutes <= existingEndMinutes) ||
            (newStartMinutes <= existingStartMinutes && newEndMinutes >= existingEndMinutes)
          );
          
          if (isOverlap) {
            return {
              conflict: true,
              conflictingBooking: booking,
              message: `è©²æ™‚æ®µèˆ‡ç¾æœ‰é ç´„è¡çªï¼ˆ${booking.start_time} - ${booking.end_time}ï¼‰`
            };
          }
        }
      }
      
      return { conflict: false };
    }

    // æª¢æŸ¥æ™‚é•·æ˜¯å¦ç¬¦åˆè¦å‰‡
    function checkDurationRules(startTime, endTime) {
      if (!startTime || !endTime) return { valid: false, message: 'è«‹é¸æ“‡æ™‚æ®µ' };
      
      const [startH, startM] = startTime.split(':').map(Number);
      const [endH, endM] = endTime.split(':').map(Number);
      const durationMinutes = (endH * 60 + endM) - (startH * 60 + startM);
      
      // æœ€å°‘1å°æ™‚
      if (durationMinutes < 60) {
        return { valid: false, message: 'é ç´„æ™‚é•·æœ€å°‘1å°æ™‚' };
      }
      
      // æª¢æŸ¥æ˜¯å¦ç¬¦åˆåŠå°æ™‚å¢é‡è¦å‰‡
      const hours = durationMinutes / 60;
      const remainder = hours % 0.5;
      if (remainder > 0.01 && remainder < 0.49) {
        return { valid: false, message: 'æ™‚é•·å¿…é ˆæ˜¯æ•´å°æ™‚æˆ–åŠå°æ™‚ï¼ˆå¦‚ï¼š1å°æ™‚ã€1.5å°æ™‚ã€2å°æ™‚ã€2.5å°æ™‚ï¼‰' };
      }
      
      return { valid: true, hours: hours };
    }

    // æ›´æ–°æ™‚æ®µè¡çªè­¦å‘Š
    function updateTimeConflictWarning() {
      const warningDiv = document.getElementById('time-conflict-warning');
      const conflictMessage = document.getElementById('conflict-message');
      
      if (!currentRoom || selectedDates.length === 0) {
        warningDiv.style.display = 'none';
        return;
      }

      const startTime = document.getElementById('start-time-select').value;
      const endTime = document.getElementById('end-time-select').value;

      if (!startTime || !endTime) {
        warningDiv.style.display = 'none';
        return;
      }

      let hasConflict = false;
      let conflictDetails = [];

      for (const date of selectedDates) {
        const dateStr = date.toISOString().split('T')[0];
        const conflict = checkTimeConflict(currentRoom, dateStr, startTime, endTime);
        
        if (conflict.conflict) {
          hasConflict = true;
          const dateDisplay = `${date.getMonth() + 1}/${date.getDate()}`;
          conflictDetails.push(`${dateDisplay}: ${conflict.message}`);
        }
      }

      if (hasConflict) {
        warningDiv.style.display = 'block';
        conflictMessage.innerHTML = conflictDetails.join('<br>');
      } else {
        warningDiv.style.display = 'none';
      }
    }

    // æ›´æ–°æ™‚é•·è­¦å‘Š
    function updateDurationWarning() {
      const warningDiv = document.getElementById('duration-warning');
      
      const startTime = document.getElementById('start-time-select').value;
      const endTime = document.getElementById('end-time-select').value;

      if (!startTime || !endTime) {
        warningDiv.style.display = 'none';
        return;
      }

      const durationCheck = checkDurationRules(startTime, endTime);
      
      if (!durationCheck.valid) {
        warningDiv.style.display = 'block';
      } else {
        warningDiv.style.display = 'none';
      }
    }

    // åˆå§‹åŒ–æ‡‰ç”¨
    function initializeApp() {
      loadBookings();
      initializeEventListeners();
      generateTimeOptions();
      setupLoginMode();
      
      const currentYear = new Date().getFullYear();
      document.getElementById('current-year-display').textContent = currentYear;
      
      currentCalendarMonth = new Date();
      renderCalendar();
    }

    function setupLoginMode() {
      document.getElementById('public-access-btn').addEventListener('click', () => {
        isPublicMode = true;
        isStaffMode = false;
        enterPublicMode();
      });

      document.getElementById('staff-login-btn').addEventListener('click', () => {
        const password = document.getElementById('staff-password').value;
        if (password === STAFF_PASSWORD) {
          isStaffMode = true;
          isPublicMode = false;
          enterStaffMode();
        } else {
          showToast('âŒ å¯†ç¢¼éŒ¯èª¤', 'error');
        }
      });

      document.getElementById('staff-password').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
          document.getElementById('staff-login-btn').click();
        }
      });
    }

    function enterPublicMode() {
      document.getElementById('login-overlay').style.display = 'none';
      document.getElementById('app-content').style.display = 'flex';
      document.getElementById('public-mode-badge').style.display = 'block';
      document.getElementById('sidebar').style.display = 'none';
      document.getElementById('statistics-section').style.display = 'none';
      
      document.querySelector('main').style.width = '100%';
      
      document.getElementById('returning-customer-container').style.display = 'none';
      document.getElementById('staff-payment-section').style.display = 'none';
      document.getElementById('payment-instructions').style.display = 'block';
      
      renderCalendar();
    }

    function enterStaffMode() {
      document.getElementById('login-overlay').style.display = 'none';
      document.getElementById('app-content').style.display = 'flex';
      document.getElementById('public-mode-badge').style.display = 'none';
      document.getElementById('sidebar').style.display = 'flex';
      document.getElementById('statistics-section').style.display = 'flex';
      
      document.querySelector('main > section').style.width = '70%';
      document.querySelector('main > aside').style.width = '30%';
      
      document.getElementById('returning-customer-container').style.display = 'block';
      document.getElementById('staff-payment-section').style.display = 'block';
      document.getElementById('payment-instructions').style.display = 'none';
      
      renderCalendar();
      renderBookingList();
      updateStatistics();
    }

    function initializeEventListeners() {
      document.getElementById('today-btn').addEventListener('click', () => {
        currentCalendarMonth = new Date();
        renderCalendar();
      });

      document.getElementById('prev-month-btn').addEventListener('click', () => {
        currentCalendarMonth.setMonth(currentCalendarMonth.getMonth() - 1);
        renderCalendar();
      });

      document.getElementById('next-month-btn').addEventListener('click', () => {
        currentCalendarMonth.setMonth(currentCalendarMonth.getMonth() + 1);
        renderCalendar();
      });

      document.querySelectorAll('.room-card').forEach(card => {
        card.addEventListener('click', () => {
          document.querySelectorAll('.room-card').forEach(c => c.classList.remove('active'));
          card.classList.add('active');
          currentRoom = card.dataset.room;
          showRoomInfo(currentRoom);
          calculatePrice();
          updateTimeConflictWarning();
          updateDurationWarning();
        });
      });

      // æ™‚é•·æŒ‰éˆ•äº‹ä»¶
      document.querySelectorAll('.duration-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          const startTime = document.getElementById('start-time-select').value;
          if (!startTime) {
            showToast('è«‹å…ˆé¸æ“‡é–‹å§‹æ™‚é–“', 'warning');
            return;
          }
          
          const hours = parseFloat(btn.dataset.hours);
          const [startH, startM] = startTime.split(':').map(Number);
          const totalMinutes = startH * 60 + startM + (hours * 60);
          
          let endH = Math.floor(totalMinutes / 60);
          let endM = totalMinutes % 60;
          
          if (endH > 22 || (endH === 22 && endM > 0)) {
            endH = 22;
            endM = 0;
            showToast('çµæŸæ™‚é–“å·²èª¿æ•´è‡³22:00', 'info');
          }
          
          const endTime = `${String(endH).padStart(2, '0')}:${String(endM).padStart(2, '0')}`;
          document.getElementById('end-time-select').value = endTime;
          
          updateSelectedTimeDisplay();
          calculatePrice();
          updateTimeConflictWarning();
          updateDurationWarning();
        });
      });

      document.getElementById('start-time-select').addEventListener('change', () => {
        updateSelectedTimeDisplay();
        calculatePrice();
        updateTimeConflictWarning();
        updateDurationWarning();
      });

      document.getElementById('end-time-select').addEventListener('change', () => {
        updateSelectedTimeDisplay();
        calculatePrice();
        updateTimeConflictWarning();
        updateDurationWarning();
      });

      document.getElementById('purpose-select').addEventListener('change', calculatePrice);
      document.getElementById('is-returning-customer').addEventListener('change', calculatePrice);
      document.getElementById('video-service-checkbox').addEventListener('change', calculatePrice);

      document.getElementById('room-filter').addEventListener('change', (e) => {
        currentRoomFilter = e.target.value;
        renderBookingList();
      });

      document.getElementById('status-filter').addEventListener('change', (e) => {
        currentStatusFilter = e.target.value;
        renderBookingList();
      });

      document.getElementById('date-sort').addEventListener('change', (e) => {
        currentDateSort = e.target.value;
        renderBookingList();
      });

      document.getElementById('booking-form').addEventListener('submit', (e) => {
        e.preventDefault();
        if (isStaffMode) {
          handleFormSubmit('pending');
        } else {
          handlePublicBooking();
        }
      });

      document.getElementById('submit-paid-btn').addEventListener('click', () => {
        handleFormSubmit('paid');
      });

      document.getElementById('submit-pending-btn').addEventListener('click', () => {
        handleFormSubmit('pending');
      });
    }

    function showRoomInfo(roomId) {
      const room = rooms.find(r => r.id === roomId);
      if (!room) return;

      document.getElementById('room-info').style.display = 'block';
      document.getElementById('room-info-title').textContent = `${room.name} ${room.subtitle}`;
      document.getElementById('room-info-area').textContent = room.area;
      document.getElementById('room-info-capacity').textContent = room.capacity;
      document.getElementById('room-info-equipment').textContent = room.equipment;
      
      // æ ¹æ“šæˆ¿é–“é¡å‹é¡¯ç¤ºä¸åŒçš„æ”¶è²»ä¿¡æ¯
      if (['B', 'C', 'D', 'E'].includes(roomId)) {
        document.getElementById('room-info-rates').textContent = 'å¹³æ—¥(å…¨æ—¥), å…­åŠæ—¥(2pmå‰) $60 / å…­åŠæ—¥(2pmå¾Œ)åŠå‡æ—¥(å…¨æ—¥) $90';
      } else if (roomId === '2') {
        document.getElementById('room-info-rates').textContent = 'å¹³æ—¥(å…¨æ—¥), å…­åŠæ—¥(2pmå‰) $80 / å…­åŠæ—¥(2pmå¾Œ)åŠå‡æ—¥(å…¨æ—¥) $120';
      } else if (roomId === 'A') {
        document.getElementById('room-info-rates').textContent = `å¹³æ—¥$${room.rates.weekday} / å‡æ—¥$${room.rates.weekend}`;
      } else if (roomId === '1') {
        document.getElementById('room-info-rates').textContent = `å¹³æ—¥$${room.rates.weekday} / å‡æ—¥$${room.rates.weekend}`;
      }

      if (room.hasVideo) {
        document.getElementById('room-info-video').style.display = 'block';
        document.getElementById('room-info-video-rates').textContent = `å¹³æ—¥$${room.videoRates.weekday} / å‡æ—¥$${room.videoRates.weekend}`;
      } else {
        document.getElementById('room-info-video').style.display = 'none';
      }
    }

    function generateTimeOptions() {
      const startSelect = document.getElementById('start-time-select');
      const endSelect = document.getElementById('end-time-select');
      
      startSelect.innerHTML = '<option value="">è«‹é¸æ“‡</option>';
      endSelect.innerHTML = '<option value="">è«‹é¸æ“‡</option>';

      for (let h = 8; h <= 22; h++) {
        if (h < 22) {
          const time = `${String(h).padStart(2, '0')}:00`;
          const displayTime = formatTime(time);
          
          const option1 = document.createElement('option');
          option1.value = time;
          option1.textContent = displayTime;
          startSelect.appendChild(option1);

          const option2 = document.createElement('option');
          option2.value = time;
          option2.textContent = displayTime;
          endSelect.appendChild(option2);
        }
        
        if (h < 22) {
          const time = `${String(h).padStart(2, '0')}:30`;
          const displayTime = formatTime(time);
          
          const option1 = document.createElement('option');
          option1.value = time;
          option1.textContent = displayTime;
          startSelect.appendChild(option1);

          const option2 = document.createElement('option');
          option2.value = time;
          option2.textContent = displayTime;
          endSelect.appendChild(option2);
        }
      }

      const endOption = document.createElement('option');
      endOption.value = '22:00';
      endOption.textContent = formatTime('22:00');
      endSelect.appendChild(endOption);
    }

    function formatTime(time) {
      const [h, m] = time.split(':').map(Number);
      if (h < 12) return `ä¸Šåˆ${h}:${String(m).padStart(2, '0')}`;
      if (h === 12) return `ä¸‹åˆ${h}:${String(m).padStart(2, '0')}`;
      return `ä¸‹åˆ${h-12}:${String(m).padStart(2, '0')}`;
    }

    function updateSelectedTimeDisplay() {
      const startTime = document.getElementById('start-time-select').value;
      const endTime = document.getElementById('end-time-select').value;
      const display = document.getElementById('selected-time-display');

      if (!startTime || !endTime) {
        display.innerHTML = '<span class="text-gray-500">å°šæœªé¸æ“‡</span>';
      } else {
        const [startH, startM] = startTime.split(':').map(Number);
        const [endH, endM] = endTime.split(':').map(Number);
        const durationMinutes = (endH * 60 + endM) - (startH * 60 + startM);
        const hours = durationMinutes / 60;
        
        display.innerHTML = `${formatTime(startTime)} - ${formatTime(endTime)} <span class="text-pink-600">(ç¸½æ™‚é•·ï¼š${hours}å°æ™‚)</span>`;
      }
    }

    function renderCalendar() {
      const grid = document.getElementById('calendar-grid');
      grid.innerHTML = '';

      const year = currentCalendarMonth.getFullYear();
      const month = currentCalendarMonth.getMonth();

      document.getElementById('calendar-month-year').textContent = `${year}å¹´${month + 1}æœˆ`;

      const firstDay = new Date(year, month, 1);
      const lastDay = new Date(year, month + 1, 0);
      const startDay = firstDay.getDay();
      const daysInMonth = lastDay.getDate();

      const today = new Date();
      today.setHours(12, 0, 0, 0);

      for (let i = 0; i < startDay; i++) {
        const emptyDiv = document.createElement('div');
        emptyDiv.className = 'calendar-day disabled';
        grid.appendChild(emptyDiv);
      }

      for (let day = 1; day <= daysInMonth; day++) {
        const date = new Date(year, month, day, 12, 0, 0, 0);
        const dayDiv = document.createElement('div');
        dayDiv.className = 'calendar-day';
        
        const span = document.createElement('span');
        span.textContent = day;
        dayDiv.appendChild(span);

        const isToday = date.getTime() === today.getTime();
        const isSelected = selectedDates.some(d => d.getTime() === date.getTime());
        
        const dateStr = date.toISOString().split('T')[0];
        const isPublicHolidayDate = !!publicHolidays[dateStr];
        const isWeekendDay = date.getDay() === 0 || date.getDay() === 6;
        
        // æª¢æŸ¥æ˜¯å¦æœ‰é ç´„
        const hasBookingOnDate = bookings.some(b => {
          return b.start_date === dateStr && b.payment_status !== 'cancelled';
        });
        
        // ç´…åœˆæ¨™è¨˜ï¼šå…¬çœ¾å‡æœŸæˆ–é€±æœ«
        if (isPublicHolidayDate || isWeekendDay) {
          dayDiv.classList.add('red-circle');
        }
        
        // å³ä¸Šè§’ç´…é»ï¼šå·²æœ‰é ç´„
        if (hasBookingOnDate) {
          dayDiv.classList.add('has-booking');
        }

        if (isToday) dayDiv.classList.add('today');
        if (isSelected) dayDiv.classList.add('selected');

        if (isPublicMode && date < today) {
          dayDiv.classList.add('disabled');
        }

        if (!dayDiv.classList.contains('disabled')) {
          dayDiv.addEventListener('click', () => toggleDateSelection(date));
        }

        grid.appendChild(dayDiv);
      }
    }

    function toggleDateSelection(date) {
      const normalizedDate = new Date(date.getFullYear(), date.getMonth(), date.getDate(), 12, 0, 0, 0);
      const dateTime = normalizedDate.getTime();
      const index = selectedDates.findIndex(d => d.getTime() === dateTime);
      
      if (index > -1) {
        selectedDates.splice(index, 1);
      } else {
        selectedDates.push(normalizedDate);
      }
      
      selectedDates.sort((a, b) => a - b);
      updateSelectedDatesDisplay();
      updateDateNatureAlerts();
      renderCalendar();
      calculatePrice();
      updateTimeConflictWarning();
      updateDurationWarning();
    }

    function updateSelectedDatesDisplay() {
      const display = document.getElementById('selected-dates-display');
      const countEl = document.getElementById('selected-count');
      
      countEl.textContent = selectedDates.length;
      
      if (selectedDates.length === 0) {
        display.innerHTML = '<span class="text-xs text-gray-500">å°šæœªé¸æ“‡</span>';
      } else {
        display.innerHTML = selectedDates.map(d => {
          const dateStr = `${d.getMonth() + 1}/${d.getDate()}`;
          const dayNames = ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'];
          const dayStr = dayNames[d.getDay()];
          const isHolidayRate = isWeekend(d) || isPublicHoliday(d);
          
          const bgColor = isHolidayRate ? 'from-red-500 to-red-600' : 'from-pink-500 to-pink-600';
          return `<span class="px-3 py-1 bg-gradient-to-r ${bgColor} text-white rounded-lg text-xs font-bold">${dateStr} (${dayStr})</span>`;
        }).join('');
      }
    }

    function updateDateNatureAlerts() {
      const container = document.getElementById('date-nature-alerts-container');
      
      if (selectedDates.length === 0) {
        container.innerHTML = '';
        return;
      }

      const alerts = selectedDates.map(date => {
        const dateStr = `${date.getFullYear()}å¹´${date.getMonth() + 1}æœˆ${date.getDate()}æ—¥`;
        const dayNames = ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'];
        const dayStr = `æ˜ŸæœŸ${dayNames[date.getDay()]}`;
        const holidayName = isPublicHoliday(date);
        const isWeekendDay = isWeekend(date);
        
        let alertClass, alertIcon, natureText, rateText;
        
        if (isWeekendDay) {
          alertClass = 'holiday-type';
          alertIcon = 'âš ï¸';
          natureText = 'é€±æœ«';
          rateText = 'å°‡è‡ªå‹•å¥—ç”¨å‡æ—¥æ”¶è²»æ¨™æº–';
        } else if (holidayName) {
          alertClass = 'public-holiday-type';
          alertIcon = 'â„¹ï¸';
          natureText = `ã€Œ${holidayName}ã€å…¬çœ¾å‡æœŸ`;
          rateText = 'å°‡å¥—ç”¨å‡æ—¥æ”¶è²»æ¨™æº–';
        } else {
          alertClass = 'weekday-type';
          alertIcon = 'âœ…';
          natureText = 'æ™®é€šå·¥ä½œæ—¥';
          rateText = 'å°‡å¥—ç”¨å¹³æ—¥æ”¶è²»æ¨™æº–';
        }
        
        return `
          <div class="date-nature-alert ${alertClass}">
            <div class="flex items-start gap-3">
              <div class="text-3xl">${alertIcon}</div>
              <div class="flex-1">
                <h4 class="text-base font-bold mb-2" style="color: ${alertClass === 'holiday-type' ? '#B91C1C' : alertClass === 'public-holiday-type' ? '#4338CA' : '#15803D'}">ğŸ’¡ ç³»çµ±æç¤ºï¼š</h4>
                <p class="text-sm font-semibold mb-1" style="color: ${alertClass === 'holiday-type' ? '#991B1B' : alertClass === 'public-holiday-type' ? '#3730A3' : '#166534'}">æ‚¨é¸æ“‡çš„ <strong>${dateStr} ${dayStr}</strong></p>
                <p class="text-sm font-semibold mb-1" style="color: ${alertClass === 'holiday-type' ? '#991B1B' : alertClass === 'public-holiday-type' ? '#3730A3' : '#166534'}">ç‚º <strong>${natureText}</strong></p>
                <p class="text-sm font-bold" style="color: ${alertClass === 'holiday-type' ? '#DC2626' : alertClass === 'public-holiday-type' ? '#4F46E5' : '#16A34A'}">${rateText}</p>
              </div>
            </div>
          </div>
        `;
      }).join('');
      
      container.innerHTML = alerts;
    }

    function isWeekend(date) {
      const day = date.getDay();
      return day === 0 || day === 6;
    }

    function isPublicHoliday(date) {
      const dateStr = date.toISOString().split('T')[0];
      return publicHolidays[dateStr];
    }

    function calculatePrice() {
      updateDateNatureAlerts();

      if (!currentRoom || selectedDates.length === 0) {
        document.getElementById('price-breakdown').innerHTML = '<p class="text-gray-500 text-center text-sm">è«‹é¸æ“‡æˆ¿é–“ã€æ—¥æœŸå’Œæ™‚æ®µ</p>';
        document.getElementById('total-price-display').textContent = '$0';
        document.getElementById('manual-price').value = '0';
        document.getElementById('video-service-option').style.display = 'none';
        document.getElementById('discount-display').style.display = 'none';
        return;
      }

      const startTime = document.getElementById('start-time-select').value;
      const endTime = document.getElementById('end-time-select').value;

      if (!startTime || !endTime) {
        document.getElementById('price-breakdown').innerHTML = '<p class="text-gray-500 text-center text-sm">è«‹é¸æ“‡æ™‚æ®µ</p>';
        document.getElementById('total-price-display').textContent = '$0';
        document.getElementById('manual-price').value = '0';
        document.getElementById('video-service-option').style.display = 'none';
        document.getElementById('discount-display').style.display = 'none';
        return;
      }

      // æª¢æŸ¥æ™‚é•·è¦å‰‡
      const durationCheck = checkDurationRules(startTime, endTime);
      if (!durationCheck.valid) {
        document.getElementById('price-breakdown').innerHTML = `<p class="text-red-600 font-bold text-center">${durationCheck.message}</p>`;
        return;
      }

      const purpose = document.getElementById('purpose-select').value;
      const isReturning = isStaffMode ? document.getElementById('is-returning-customer').checked : false;
      const room = rooms.find(r => r.id === currentRoom);
      const hasVideo = document.getElementById('video-service-checkbox').checked;
      const hours = durationCheck.hours;

      if (room.hasVideo) {
        document.getElementById('video-service-option').style.display = 'block';
      } else {
        document.getElementById('video-service-option').style.display = 'none';
      }

      if (purpose === 'èª¿éŸ³' || purpose === 'å…§éƒ¨ä½¿ç”¨') {
        document.getElementById('price-breakdown').innerHTML = '<p class="text-amber-600 font-bold text-center">ğŸ†“ èª¿éŸ³/å…§éƒ¨ä½¿ç”¨ - å…è²»</p>';
        document.getElementById('total-price-display').textContent = '$0';
        document.getElementById('manual-price').value = '0';
        document.getElementById('discount-display').style.display = 'none';
        return;
      }

      let breakdownHTML = '';
      let totalPrice = 0;
      let videoExtraTotal = 0;

      selectedDates.forEach(date => {
        const rate = calculateRateForRoom(currentRoom, date, startTime);
        
        let datePrice = Math.round(rate * hours);
        totalPrice += datePrice;

        // è¨ˆç®—éŒ„å½±æœå‹™é¡å¤–è²»ç”¨
        if (hasVideo && room.hasVideo) {
          const videoExtra = calculateVideoExtra(currentRoom, date, startTime);
          const videoExtraAmount = Math.round(videoExtra * hours);
          videoExtraTotal += videoExtraAmount;
          datePrice += videoExtraAmount;
          totalPrice += videoExtraAmount;
        }

        const dateStr = `${date.getMonth() + 1}æœˆ${date.getDate()}æ—¥`;
        const dayNames = ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'];
        const dayStr = `æ˜ŸæœŸ${dayNames[date.getDay()]}`;
        const holidayName = isPublicHoliday(date);
        const isWeekendDay = isWeekend(date);
        const [startHour, startMinute] = startTime.split(':').map(Number);
        const isAfter2PM = startHour >= 14;
        
        let natureLabel, cardClass, textColor, circleEmoji, rateDetail = '';
        
        if (isWeekendDay) {
          natureLabel = 'é€±æœ«';
          cardClass = 'holiday-calc';
          textColor = '#991B1B';
          circleEmoji = ' ğŸ”´';
          
          // æ·»åŠ é€±æœ«æ™‚é–“æ®µèªªæ˜
          if (isAfter2PM) {
            rateDetail = 'ï¼ˆé€±æœ«2PMå¾Œï¼‰';
          } else {
            rateDetail = 'ï¼ˆé€±æœ«2PMå‰ï¼‰';
          }
        } else if (holidayName) {
          natureLabel = `${holidayName}ï¼ˆå…¬çœ¾å‡æœŸï¼‰`;
          cardClass = 'holiday-calc';
          textColor = '#991B1B';
          circleEmoji = ' ğŸ”´';
          rateDetail = 'ï¼ˆå‡æ—¥å…¨æ—¥ï¼‰';
        } else {
          natureLabel = 'æ™®é€šå·¥ä½œæ—¥';
          cardClass = 'weekday-calc';
          textColor = '#166534';
          circleEmoji = '';
          rateDetail = 'ï¼ˆå¹³æ—¥å…¨æ—¥ï¼‰';
        }
        
        const serviceType = (hasVideo && room.hasVideo) ? ' (å«éŒ„å½±)' : '';
        const rateLabel = (isWeekendDay || holidayName) ? 'å‡æ—¥è²»ç‡' : 'å¹³æ—¥è²»ç‡';
        
        breakdownHTML += `
          <div class="calculation-card ${cardClass}">
            <p class="text-xs font-bold mb-2" style="color: ${textColor}">ğŸ“Š è²»ç”¨è¨ˆç®—</p>
            <div style="border-bottom: 2px dashed ${(isWeekendDay || holidayName) ? '#FCA5A5' : '#86EFAC'}; padding-bottom: 8px; margin-bottom: 8px;">
              <p class="text-sm font-semibold mb-1" style="color: ${textColor}"><strong>æ—¥æœŸï¼š</strong>${dateStr} (${dayStr})${circleEmoji}</p>
              <p class="text-sm font-semibold mb-1" style="color: ${textColor}"><strong>æ€§è³ªï¼š</strong>${natureLabel}${rateDetail}</p>
              <p class="text-sm font-semibold" style="color: ${textColor}"><strong>è²»ç‡ï¼š</strong>${rateLabel} $${rate}/å°æ™‚</p>
            </div>
            <p class="text-base font-bold mb-2" style="color: ${textColor}">
              ${room.name}${serviceType} Ã— ${hours}å°æ™‚
            </p>
            <div style="border-top: 2px dashed ${(isWeekendDay || holidayName) ? '#FCA5A5' : '#86EFAC'}; padding-top: 8px; margin-top: 8px;">
              <p class="text-sm font-semibold" style="color: ${textColor}">å°è¨ˆï¼š<span class="text-lg font-bold">$${datePrice}</span></p>
            </div>
          </div>
        `;
      });

      if (room.hasVideo) {
        document.getElementById('video-service-price').textContent = `+$${videoExtraTotal}`;
      }

      const originalPrice = totalPrice;

      if (isReturning) {
        totalPrice = Math.round(totalPrice * 0.9);
        document.getElementById('discount-display').style.display = 'block';
        document.getElementById('original-price-text').textContent = `$${originalPrice}`;
        document.getElementById('discount-price-text').textContent = `$${totalPrice}`;
      } else {
        document.getElementById('discount-display').style.display = 'none';
      }

      document.getElementById('price-breakdown').innerHTML = breakdownHTML;
      document.getElementById('total-price-display').textContent = '$' + totalPrice;
      document.getElementById('manual-price').value = totalPrice;
    }

    async function handlePublicBooking() {
      if (!currentRoom) {
        showToast('è«‹é¸æ“‡æˆ¿é–“', 'error');
        return;
      }

      if (selectedDates.length === 0) {
        showToast('è«‹é¸æ“‡æ—¥æœŸ', 'error');
        return;
      }

      const startTime = document.getElementById('start-time-select').value;
      const endTime = document.getElementById('end-time-select').value;

      if (!startTime || !endTime) {
        showToast('è«‹é¸æ“‡æ™‚é–“', 'error');
        return;
      }

      // æª¢æŸ¥æ™‚é•·è¦å‰‡
      const durationCheck = checkDurationRules(startTime, endTime);
      if (!durationCheck.valid) {
        showToast(`âš ï¸ ${durationCheck.message}`, 'warning');
        return;
      }

      // æª¢æŸ¥æ™‚æ®µè¡çª
      let hasTimeConflict = false;
      for (const date of selectedDates) {
        const dateStr = date.toISOString().split('T')[0];
        const conflict = checkTimeConflict(currentRoom, dateStr, startTime, endTime);
        if (conflict.conflict) {
          hasTimeConflict = true;
          showToast(`âš ï¸ ${dateStr} ${conflict.message}`, 'warning');
          break;
        }
      }

      if (hasTimeConflict) {
        return;
      }

      const userName = document.getElementById('user-name').value;
      const phone = document.getElementById('phone').value;
      const purpose = document.getElementById('purpose-select').value;
      const notes = document.getElementById('notes').value;
      const hasVideo = document.getElementById('video-service-checkbox').checked;
      const manualPrice = parseInt(document.getElementById('manual-price').value) || 0;
      const calculatedPrice = parseInt(document.getElementById('total-price-display').textContent.replace('$', ''));

      const btn = document.getElementById('submit-booking-btn');
      const originalText = btn.textContent;
      btn.disabled = true;
      btn.textContent = 'â³ è™•ç†ä¸­...';

      let successCount = 0;

      for (const date of selectedDates) {
        const holidayName = isPublicHoliday(date);
        const isWeekendDay = isWeekend(date);
        
        let dateNature = 'å¹³æ—¥';
        if (isWeekendDay) {
          dateNature = 'é€±æœ«';
        } else if (holidayName) {
          dateNature = holidayName;
        }

        const today = new Date();
        today.setHours(0, 0, 0, 0);
        const isPastDate = date < today;

        const booking = {
          id: Date.now().toString() + Math.random().toString(36).substr(2, 9),
          room_id: currentRoom,
          start_date: date.toISOString().split('T')[0],
          start_time: startTime,
          end_time: endTime,
          user_name: userName,
          phone: phone,
          purpose: purpose,
          notes: notes,
          total_amount: manualPrice,
          original_amount: calculatedPrice,
          payment_status: 'pending',
          is_returning_customer: false,
          manual_price_override: false,
          created_at: new Date().toISOString(),
          has_video_service: hasVideo,
          date_nature: dateNature,
          is_past_date: isPastDate
        };

        bookings.push(booking);
        successCount++;
      }

      btn.disabled = false;
      btn.textContent = originalText;

      if (successCount > 0) {
        saveBookings();
        showToast(`âœ… æˆåŠŸæäº¤ ${successCount} ç­†é ç´„ç”³è«‹ï¼Œè«‹ç­‰å€™WhatsAppè¯çµ¡`, 'success');
        resetForm();
      }
    }

    async function handleFormSubmit(paymentStatus) {
      if (!currentRoom) {
        showToast('è«‹é¸æ“‡æˆ¿é–“', 'error');
        return;
      }

      if (selectedDates.length === 0) {
        showToast('è«‹é¸æ“‡æ—¥æœŸ', 'error');
        return;
      }

      const startTime = document.getElementById('start-time-select').value;
      const endTime = document.getElementById('end-time-select').value;

      if (!startTime || !endTime) {
        showToast('è«‹é¸æ“‡æ™‚é–“', 'error');
        return;
      }

      // æª¢æŸ¥æ™‚é•·è¦å‰‡
      const durationCheck = checkDurationRules(startTime, endTime);
      if (!durationCheck.valid) {
        showToast(`âš ï¸ ${durationCheck.message}`, 'warning');
        return;
      }

      // æª¢æŸ¥æ™‚æ®µè¡çª
      let hasTimeConflict = false;
      for (const date of selectedDates) {
        const dateStr = date.toISOString().split('T')[0];
        const conflict = checkTimeConflict(currentRoom, dateStr, startTime, endTime);
        if (conflict.conflict) {
          hasTimeConflict = true;
          showToast(`âš ï¸ ${dateStr} ${conflict.message}`, 'warning');
          break;
        }
      }

      if (hasTimeConflict) {
        return;
      }

      const userName = document.getElementById('user-name').value;
      const phone = document.getElementById('phone').value;
      const purpose = document.getElementById('purpose-select').value;
      const notes = document.getElementById('notes').value;
      const isReturning = document.getElementById('is-returning-customer').checked;
      const hasVideo = document.getElementById('video-service-checkbox').checked;
      const manualPrice = parseInt(document.getElementById('manual-price').value) || 0;
      const calculatedPrice = parseInt(document.getElementById('total-price-display').textContent.replace('$', ''));

      const btn = paymentStatus === 'paid' ? document.getElementById('submit-paid-btn') : document.getElementById('submit-pending-btn');
      const originalText = btn.textContent;
      btn.disabled = true;
      btn.textContent = 'â³ è™•ç†ä¸­...';

      let successCount = 0;

      for (const date of selectedDates) {
        const holidayName = isPublicHoliday(date);
        const isWeekendDay = isWeekend(date);
        
        let dateNature = 'å¹³æ—¥';
        if (isWeekendDay) {
          dateNature = 'é€±æœ«';
        } else if (holidayName) {
          dateNature = holidayName;
        }

        const today = new Date();
        today.setHours(0, 0, 0, 0);
        const isPastDate = date < today;

        const booking = {
          id: Date.now().toString() + Math.random().toString(36).substr(2, 9),
          room_id: currentRoom,
          start_date: date.toISOString().split('T')[0],
          start_time: startTime,
          end_time: endTime,
          user_name: userName,
          phone: phone,
          purpose: purpose,
          notes: notes,
          total_amount: manualPrice,
          original_amount: calculatedPrice,
          payment_status: paymentStatus,
          is_returning_customer: isReturning,
          manual_price_override: manualPrice !== calculatedPrice,
          created_at: new Date().toISOString(),
          has_video_service: hasVideo,
          date_nature: dateNature,
          is_past_date: isPastDate
        };

        bookings.push(booking);
        successCount++;
      }

      btn.disabled = false;
      btn.textContent = originalText;

      if (successCount > 0) {
        saveBookings();
        const statusText = paymentStatus === 'paid' ? 'å·²ä»˜æ¬¾' : 'å¾…ä»˜æ¬¾';
        showToast(`âœ… æˆåŠŸå‰µå»º ${successCount} ç­†é ç´„ï¼ˆ${statusText}ï¼‰`, 'success');
        resetForm();
        renderBookingList();
        updateStatistics();
      }
    }

    function resetForm() {
      document.getElementById('booking-form').reset();
      selectedDates = [];
      currentRoom = '';
      updateSelectedDatesDisplay();
      updateSelectedTimeDisplay();
      updateDateNatureAlerts();
      updateTimeConflictWarning();
      updateDurationWarning();
      renderCalendar();
      document.getElementById('room-info').style.display = 'none';
      document.getElementById('price-breakdown').innerHTML = '<p class="text-gray-500 text-center text-sm">è«‹é¸æ“‡æˆ¿é–“ã€æ—¥æœŸå’Œæ™‚æ®µ</p>';
      document.getElementById('total-price-display').textContent = '$0';
      document.getElementById('video-service-option').style.display = 'none';
      document.getElementById('discount-display').style.display = 'none';
      document.querySelectorAll('.room-card').forEach(c => c.classList.remove('active'));
    }

    function renderBookingList() {
      if (!isStaffMode) return;
      
      const container = document.getElementById('booking-list');
      
      let filteredBookings = bookings;
      
      if (currentRoomFilter) {
        filteredBookings = filteredBookings.filter(b => b.room_id === currentRoomFilter);
      }

      if (currentStatusFilter) {
        filteredBookings = filteredBookings.filter(b => b.payment_status === currentStatusFilter);
      }

      // æ ¹æ“šæ’åºé¸é …æ’åº
      const today = new Date();
      today.setHours(0, 0, 0, 0);

      filteredBookings.sort((a, b) => {
        const dateA = new Date(a.start_date);
        const dateB = new Date(b.start_date);
        const isFutureA = dateA >= today;
        const isFutureB = dateB >= today;

        switch (currentDateSort) {
          case 'future-first':
            if (isFutureA && !isFutureB) return -1;
            if (!isFutureA && isFutureB) return 1;
            return dateA - dateB;
          case 'past-first':
            if (!isFutureA && isFutureB) return -1;
            if (isFutureA && !isFutureB) return 1;
            return dateB - dateA;
          case 'newest':
            return new Date(b.created_at) - new Date(a.created_at);
          default:
            return dateA - dateB;
        }
      });

      if (filteredBookings.length === 0) {
        container.innerHTML = '<p class="text-center text-gray-400 py-8 text-sm">æš«ç„¡é ç´„è¨˜éŒ„</p>';
        return;
      }

      container.innerHTML = filteredBookings.map(booking => {
        const room = rooms.find(r => r.id === booking.room_id);
        const dateObj = new Date(booking.start_date);
        const dayNames = ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'];
        
        let dateStr = `${dateObj.getFullYear()}/${dateObj.getMonth() + 1}/${dateObj.getDate()} æ˜ŸæœŸ${dayNames[dateObj.getDay()]}`;
        let dateLabel = '';
        
        const dateNature = booking.date_nature || '';
        const isWeekendDay = dateObj.getDay() === 0 || dateObj.getDay() === 6;
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        const isPastBooking = dateObj < today;
        const isFutureBooking = dateObj >= today;
        
        if (isWeekendDay) {
          dateLabel = `<span class="inline-block ml-2 px-2 py-1 bg-red-100 text-red-800 text-xs font-bold rounded">ğŸ”´ [é€±æœ«]</span>`;
        } else if (dateNature && dateNature !== 'å¹³æ—¥') {
          dateLabel = `<span class="inline-block ml-2 px-2 py-1 bg-blue-100 text-blue-800 text-xs font-bold rounded">[${dateNature}]</span>`;
        } else {
          dateLabel = '<span class="inline-block ml-2 px-2 py-1 bg-green-100 text-green-800 text-xs font-bold rounded">[å¹³æ—¥]</span>';
        }
        
        const bookingCardClass = isFutureBooking ? 'future-booking' : 'past-booking';
        
        const statusBadge = booking.payment_status === 'paid' 
          ? '<span class="status-badge status-paid">âœ… å·²ä»˜æ¬¾</span>' 
          : '<span class="status-badge status-pending">â³ å¾…ç¢ºèª</span>';

        const payButton = booking.payment_status === 'pending' 
          ? `<button class="btn-pay" onclick="confirmPayment('${booking.id}')">ğŸ’° ç¢ºèªä»˜æ¬¾</button>` 
          : '';

        return `
          <div class="booking-card ${bookingCardClass}">
            <div class="mb-2 flex justify-between items-start">
              <h4 class="font-bold text-pink-900 text-sm">
                ${room ? room.name : booking.room_id} ${room ? room.subtitle : ''}
              </h4>
              ${statusBadge}
            </div>
            
            <div class="text-xs text-pink-900 space-y-1 mb-2">
              <p><strong>ğŸ“…</strong> ${dateStr}${dateLabel}</p>
              <p><strong>â°</strong> ${formatTime(booking.start_time)} - ${formatTime(booking.end_time)}</p>
              <p><strong>ğŸ‘¤</strong> ${booking.user_name}</p>
              <p><strong>ğŸ“±</strong> ${booking.phone}</p>
              <p><strong>ğŸ¯</strong> ${booking.purpose}</p>
              ${booking.notes ? `<p><strong>ğŸ“</strong> ${booking.notes}</p>` : ''}
              ${booking.has_video_service ? '<p><strong>ğŸ“¹</strong> å«éŒ„å½±æœå‹™</p>' : ''}
              <p><strong>ğŸ’°</strong> <span class="font-bold text-pink-600">$${booking.total_amount}</span>
              ${booking.manual_price_override ? '<span class="text-xs text-orange-600"> (æ‰‹å‹•æ”¹åƒ¹)</span>' : ''}
              ${booking.is_returning_customer ? '<span class="text-xs text-green-600"> (èˆŠå®¢æˆ¶9æŠ˜)</span>' : ''}
              </p>
            </div>
            
            <div class="flex gap-2">
              ${payButton}
              <button class="btn-edit flex-1" onclick="editBooking('${booking.id}')">âœï¸ ç·¨è¼¯</button>
              <button class="btn-delete flex-1" onclick="deleteBooking('${booking.id}')">ğŸ—‘ï¸ å–æ¶ˆ</button>
            </div>
          </div>
        `;
      }).join('');
    }

    window.confirmPayment = async function(bookingId) {
      const booking = bookings.find(b => b.id === bookingId);
      if (!booking) return;

      const modal = document.createElement('div');
      modal.className = 'modal-overlay';
      modal.innerHTML = `
        <div class="modal-content p-8">
          <h3 class="text-xl font-bold text-pink-900 mb-4">ğŸ’° ç¢ºèªä»˜æ¬¾</h3>
          <p class="text-pink-800 mb-6">ç¢ºå®šå·²æ”¶åˆ° <strong>${booking.user_name}</strong> çš„æ¬¾é … <strong>$${booking.total_amount}</strong> å—ï¼Ÿ</p>
          <div class="flex gap-3">
            <button id="confirm-pay" class="btn-primary flex-1 py-3">âœ… ç¢ºèªä»˜æ¬¾</button>
            <button id="cancel-pay" class="btn-secondary flex-1 py-3">è¿”å›</button>
          </div>
        </div>
      `;
      
      document.body.appendChild(modal);

      document.getElementById('confirm-pay').addEventListener('click', async () => {
        booking.payment_status = 'paid';
        saveBookings();
        showToast('âœ… ä»˜æ¬¾ç‹€æ…‹å·²æ›´æ–°', 'success');
        document.body.removeChild(modal);
        renderBookingList();
        updateStatistics();
      });

      document.getElementById('cancel-pay').addEventListener('click', () => {
        document.body.removeChild(modal);
      });
    };

    window.editBooking = function(bookingId) {
      const booking = bookings.find(b => b.id === bookingId);
      if (!booking) return;

      const modal = document.createElement('div');
      modal.className = 'modal-overlay';
      modal.innerHTML = `
        <div class="modal-content p-8">
          <h3 class="text-2xl font-bold text-pink-900 mb-6">âœï¸ ç·¨è¼¯é ç´„</h3>
          
          <form id="edit-form" class="space-y-4">
            <div>
              <label class="block text-sm font-bold text-pink-900 mb-2">é ç´„äººå§“å</label>
              <input type="text" id="edit-name" value="${booking.user_name}" class="input-pink">
            </div>
            
            <div>
              <label class="block text-sm font-bold text-pink-900 mb-2">WhatsAppè¯çµ¡æ–¹æ³•</label>
              <input type="tel" id="edit-phone" value="${booking.phone}" class="input-pink">
            </div>
            
            <div>
              <label class="block text-sm font-bold text-pink-900 mb-2">é–‹å§‹æ™‚é–“</label>
              <select id="edit-start-time" class="select-pink">
                ${generateTimeOptionsForEdit(booking.start_time)}
              </select>
            </div>

            <div>
              <label class="block text-sm font-bold text-pink-900 mb-2">çµæŸæ™‚é–“</label>
              <select id="edit-end-time" class="select-pink">
                ${generateTimeOptionsForEdit(booking.end_time)}
              </select>
            </div>

            <div>
              <label class="block text-sm font-bold text-pink-900 mb-2">ä»˜æ¬¾ç‹€æ…‹</label>
              <select id="edit-payment-status" class="select-pink">
                <option value="pending" ${booking.payment_status === 'pending' ? 'selected' : ''}>å¾…ç¢ºèª</option>
                <option value="paid" ${booking.payment_status === 'paid' ? 'selected' : ''}>å·²ä»˜æ¬¾</option>
              </select>
            </div>
            
            <div>
              <label class="block text-sm font-bold text-pink-900 mb-2">å‚™è¨»</label>
              <textarea id="edit-notes" class="input-pink" rows="2">${booking.notes || ''}</textarea>
            </div>
            
            <div>
              <label class="block text-sm font-bold text-pink-900 mb-2">æ‰‹å‹•èª¿æ•´åƒ¹æ ¼</label>
              <div class="flex items-center gap-2">
                <span class="text-lg font-bold">$</span>
                <input type="number" id="edit-price" value="${booking.total_amount}" min="0" class="input-pink">
              </div>
            </div>
            
            <div class="flex gap-3 pt-4">
              <button type="submit" class="btn-primary flex-1 py-3">âœ… ä¿å­˜æ›´æ”¹</button>
              <button type="button" id="cancel-edit" class="btn-delete flex-1 py-3">âœ• å–æ¶ˆ</button>
            </div>
          </form>
        </div>
      `;
      
      document.body.appendChild(modal);

      document.getElementById('edit-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const newStartTime = document.getElementById('edit-start-time').value;
        const newEndTime = document.getElementById('edit-end-time').value;
        const durationCheck = checkDurationRules(newStartTime, newEndTime);
        
        if (!durationCheck.valid) {
          showToast(`âš ï¸ ${durationCheck.message}`, 'warning');
          return;
        }
        
        const conflict = checkTimeConflict(booking.room_id, booking.start_date, newStartTime, newEndTime, booking.id);
        
        if (conflict.conflict) {
          showToast(`âš ï¸ ${conflict.message}`, 'warning');
          return;
        }
        
        const newPrice = parseInt(document.getElementById('edit-price').value);
        booking.user_name = document.getElementById('edit-name').value;
        booking.phone = document.getElementById('edit-phone').value;
        booking.start_time = newStartTime;
        booking.end_time = newEndTime;
        booking.payment_status = document.getElementById('edit-payment-status').value;
        booking.notes = document.getElementById('edit-notes').value;
        booking.total_amount = newPrice;
        booking.manual_price_override = newPrice !== booking.original_amount;

        saveBookings();
        showToast('âœ… é ç´„å·²æ›´æ–°', 'success');
        document.body.removeChild(modal);
        renderBookingList();
        renderCalendar();
        updateStatistics();
      });

      document.getElementById('cancel-edit').addEventListener('click', () => {
        document.body.removeChild(modal);
      });
    };

    function generateTimeOptionsForEdit(selectedTime) {
      let options = '';
      for (let h = 8; h <= 22; h++) {
        if (h < 22) {
          const time = `${String(h).padStart(2, '0')}:00`;
          const selected = time === selectedTime ? 'selected' : '';
          options += `<option value="${time}" ${selected}>${formatTime(time)}</option>`;
        }
        
        if (h < 22) {
          const time = `${String(h).padStart(2, '0')}:30`;
          const selected = time === selectedTime ? 'selected' : '';
          options += `<option value="${time}" ${selected}>${formatTime(time)}</option>`;
        }
      }
      
      const time = '22:00';
      const selected = time === selectedTime ? 'selected' : '';
      options += `<option value="${time}" ${selected}>${formatTime(time)}</option>`;
      
      return options;
    }

    window.deleteBooking = function(bookingId) {
      const booking = bookings.find(b => b.id === bookingId);
      if (!booking) return;

      const modal = document.createElement('div');
      modal.className = 'modal-overlay';
      modal.innerHTML = `
        <div class="modal-content p-8">
          <h3 class="text-xl font-bold text-pink-900 mb-4">ğŸ—‘ï¸ ç¢ºèªå–æ¶ˆé ç´„</h3>
          <p class="text-pink-800 mb-6">ç¢ºå®šè¦å–æ¶ˆ <strong>${booking.user_name}</strong> çš„é ç´„å—ï¼Ÿ</p>
          <div class="flex gap-3">
            <button id="confirm-delete" class="btn-delete flex-1 py-3">ç¢ºèªå–æ¶ˆ</button>
            <button id="cancel-delete" class="btn-primary flex-1 py-3">è¿”å›</button>
          </div>
        </div>
      `;
      
      document.body.appendChild(modal);

      document.getElementById('confirm-delete').addEventListener('click', async () => {
        const index = bookings.findIndex(b => b.id === bookingId);
        if (index > -1) {
          bookings.splice(index, 1);
          saveBookings();
          showToast('âœ… é ç´„å·²å–æ¶ˆ', 'success');
          document.body.removeChild(modal);
          renderBookingList();
          renderCalendar();
          updateStatistics();
        }
      });

      document.getElementById('cancel-delete').addEventListener('click', () => {
        document.body.removeChild(modal);
      });
    };

    function updateStatistics() {
      if (!isStaffMode) return;
      
      const currentYear = new Date().getFullYear();
      const currentMonth = new Date().getMonth();
      
      const paidBookings = bookings.filter(b => b.payment_status === 'paid');

      const monthIncome = paidBookings
        .filter(b => {
          const date = new Date(b.start_date);
          return date.getFullYear() === currentYear && date.getMonth() === currentMonth;
        })
        .reduce((sum, b) => sum + b.total_amount, 0);

      const yearIncome = paidBookings
        .filter(b => {
          const date = new Date(b.start_date);
          return date.getFullYear() === currentYear;
        })
        .reduce((sum, b) => sum + b.total_amount, 0);

      document.getElementById('month-income').textContent = '$' + monthIncome;
      document.getElementById('year-income').textContent = '$' + yearIncome;
    }

    function showToast(message, type = 'info') {
      const container = document.getElementById('toast-container');
      const toast = document.createElement('div');
      
      const bgColors = {
        success: 'linear-gradient(135deg, #10B981 0%, #059669 100%)',
        error: 'linear-gradient(135deg, #EF4444 0%, #DC2626 100%)',
        warning: 'linear-gradient(135deg, #F59E0B 0%, #D97706 100%)',
        info: 'linear-gradient(135deg, #EC4899 0%, #DB2777 100%)'
      };
      
      toast.style.background = bgColors[type];
      toast.className = 'text-white px-6 py-3 rounded-xl shadow-2xl font-bold';
      toast.textContent = message;
      
      container.appendChild(toast);

      setTimeout(() => {
        toast.style.opacity = '0';
        toast.style.transition = 'opacity 0.4s ease';
        setTimeout(() => container.removeChild(toast), 400);
      }, 3000);
    }

    // é é¢åŠ è¼‰æ™‚åˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', initializeApp);
  </script>
</body>
</html>
